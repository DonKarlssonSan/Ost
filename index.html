<!DOCTYPE html>
<html>
<head>
  <title>Ost!</title>
  <style>

body {
  background-color: lightgrey;
}

.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
}

.margin {
  margin: 30px;
}
    
.photo {
  box-shadow: 3px 3px 3px #888888;
  position: absolute;
  top: 0;
  left: 0;
  margin: 30px;
  padding: 12px;
  background-color: white;
  cursor: move;   
}

  </style>
</head>
 
<body>
  <div id="wrapper" class="fullscreen">
    <video id="video" class="margin"></video>
    <div id="stack">
      <canvas id="canvas" width="320" height="180" style="display: none;"></canvas>
    </div>
    <br/><br/>
    <div class="margin">
      <p>
      <button id="startButton" type="button">Start webcam</button> 
      <button id="photoButton" type="button">Take photo</button>
      <button id="shareOnFacebookButton" type="button">Share on Facebook</button>
      </p>
      <p>
      You can drag your photos around!
      </p>
      <p>
      <a href="https://github.com/DonKarlssonSan/Ost">GitHub page</a>
      </p>
      <p>
      <div
        class="fb-like"
        data-share="true"
        data-width="450"
        data-show-faces="true">
      </div>
      </p>
      <p>
<!--
        <fb:login-button scope="publish_actions,user_photos" onlogin="checkLoginState();">
        </fb:login-button>
-->
        <button id="facebookLoginButton" type="button">Facebook Log In</button>

        <div id="status">
        </div>
      </p>
    </div>
  </div>  
  <script>
  (function() {
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    var canvasContext = canvas.getContext('2d');
    
    navigator.getUserMedia = (navigator.getUserMedia ||
      navigator.webkitGetUserMedia ||
      navigator.mozGetUserMedia ||
      navigator.msGetUserMedia);
		
    if (navigator.getUserMedia) {
      function gotStream(stream) {
        if (navigator.mozGetUserMedia) {
          video.mozSrcObject = stream;
        } else {
          var vendorURL = window.URL || window.webkitURL;
          video.src = vendorURL.createObjectURL(stream); 
        }
        video.play();
      }
        
      function error(message) {
        console.log(message);
      }
      
      function start() {
        this.disabled = true;
        navigator.getUserMedia( { 
          audio: false,  
          video: {
            mandatory: {
              maxWidth: 320,
              maxHeight: 180
            }
          }
        }, 
        gotStream, 
        error);
      }
      
      function getRandomNumberWithMax (max) {
        return Math.floor(Math.random() * max);
      }
      
      function takePhoto() {
        canvasContext.drawImage(video, 0, 0);
        var element = document.createElement("img");
        element.src = canvas.toDataURL();
        var angle = getRandomNumberWithMax(30) - 15;
        element.style.transform="rotate(" + angle + "deg)";
        element.style.top = getRandomNumberWithMax(50) + "px";
        element.style.left = (getRandomNumberWithMax(50) + 400) + "px"; 
        element.style.zIndex = z;
        element.className = "photo";
        element.addEventListener('dragstart', dragStart, false);
        document.getElementById("stack").appendChild(element);        
      }

      var draggedElement;
      var x, y, z = 0;

      function dragStart(e) {
        //draggedElement = this;
        draggedElement = e.target;
        x = e.clientX - draggedElement.offsetLeft;
        y = e.clientY - draggedElement.offsetTop;
        e.dataTransfer.setDragImage(draggedElement, x, y);
      }

      function drop(e) {
        z++;
        draggedElement.style.left = (e.clientX - x - 30) + "px";
        draggedElement.style.top = (e.clientY - y - 30) + "px";
        draggedElement.style.zIndex = z;
        if (e.stopPropagation) {
          e.stopPropagation();
        }
        e.preventDefault();
        return false;
      }

      function dragEnter(e) {
        e.preventDefault();
        return true;
      }

      function dragOver(e) {
        e.preventDefault();
      }
      
      function shareOnFacebook() {
        post("https://graph.facebook.com/v2.2/me/photos", function (response) {
          alert("The image was successfully posted to Facebook!");
          console.log(response);
        });
      }
      
      document.getElementById("startButton").addEventListener('click', start);
      document.getElementById("photoButton").addEventListener('click', takePhoto);      				
      document.getElementById("shareOnFacebookButton").addEventListener('click', shareOnFacebook);      				
      document.getElementById("facebookLoginButton").addEventListener('click', facebookLogin);      				

      var container = document.body;
      container.addEventListener('drop', drop, false);
      container.addEventListener('dragenter', dragEnter, false);
      container.addEventListener('dragover', dragOver, false);     
      
      // Start of evil
      // TODO: move to separate file
      var accessToken;
        
      function post (url, callback) {
        var formData = new FormData();
        formData.append("access_token", accessToken);
        //formData.append("source", blob);
        formData.append("url", "http://www.clashmusic.com/sites/default/files/styles/article_feature/public/legacy/files/johnny_cash_1.jpg"); // just testing
        formData.append("message", "Say cheese!");
        var request = new XMLHttpRequest();
        request.open("POST", url, true);
        // This is needed when uploading an image with the source parameter
        //request.setRequestHeader("Content-type", "multipart/form-data");
        
        //request.setRequestHeader("Content-length", params.length);
        //request.setRequestHeader("Connection", "close");

        request.onreadystatechange = function() {
          if(request.readyState == 4 && request.status == 200) {
            callback(request.responseText);
          } else {
            console.log(request.responseText);
          }
        }

        request.send(formData);
      }
      
      // TODO: remove
      function testAPI() {
        console.log('Welcome!  Fetching your information.... ');
        FB.api('/me', function(response) {
          console.log('Successful login for: ' + response.name);
          document.getElementById('status').innerHTML =
          'Thanks for logging in, ' + response.name + '!';
        });
      }
        
      function statusChangeCallback(response) {
        console.log('statusChangeCallback');
        console.log(response);
        // The response object is returned with a status field that lets the
        // app know the current login status of the person.
        // Full docs on the response object can be found in the documentation
        // for FB.getLoginStatus().
        if (response.status === 'connected') {
          accessToken = response.authResponse.accessToken;
          // Logged into your app and Facebook.
          testAPI();
        } else if (response.status === 'not_authorized') {
          // The person is logged into Facebook, but not your app.
          document.getElementById('status').innerHTML = 'Please log ' +
          'into this app.';
        } else {
          // The person is not logged into Facebook, so we're not sure if
          // they are logged into this app or not.
          document.getElementById('status').innerHTML = 'Please log ' +
          'into Facebook.';
        }
      }

      function facebookLogin() {
        FB.login(function(response) {
          checkLoginState();
          }, {scope: "publish_actions,user_photos"}
        );
      }
      
      // This function is called when someone finishes with the Login
      // Button.  See the onlogin handler attached to it in the sample
      // code below.
      function checkLoginState() {
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
      }   
        
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '598745043558427',
          xfbml      : true,
          version    : 'v2.2'
        });
      };

      (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    } else {
      document.getElementById("startButton").disabled = true;
      document.getElementById("photoButton").disabled = true;
      
      alert("Sorry, you can't capture video from your webcam in this web browser. Try the latest desktop version of Firefox, Chrome or Opera.");
    }
  })();
  </script>
</body>
</html>
